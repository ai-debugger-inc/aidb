# Automated Version Updates
# This workflow checks for new language and adapter versions, auto-merges patches, and creates PRs for manual review

name: Update Versions

on:
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      section:
        description: 'Section to update'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - infrastructure
          - adapters
      language:
        description: 'Specific language to update (leave empty for all)'
        required: false
        type: string
      force_release:
        description: 'Force release even for non-patch updates'
        required: false
        default: false
        type: boolean

jobs:
  load-versions:
    uses: ./.github/workflows/load-versions.yaml

  check-versions:
    runs-on: ubuntu-latest
    needs: load-versions
    permissions:
      contents: write
      pull-requests: write
      actions: write
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      auto_merge: ${{ steps.check.outputs.auto_merge }}
      update_types: ${{ steps.check.outputs.update_types }}
      changes: ${{ steps.check.outputs.changes }}

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ needs.load-versions.outputs.python-version }}

      - name: Install dependencies
        run: |
          pip install pyyaml requests packaging tomli

      - name: Check for version updates
        id: check
        run: |
          python .github/scripts/version_management/cli.py \
            --config versions.json \
            --section "${{ github.event.inputs.section || 'all' }}" \
            --output-github

      - name: Update config with changes
        if: steps.check.outputs.has_updates == 'true'
        run: |
          python .github/scripts/version_management/cli.py \
            --config versions.json \
            --section "${{ github.event.inputs.section || 'all' }}" \
            --update

      - name: Commit to maintenance branch
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -B maintenance
          git add versions.json

          # Create commit message based on update types
          if [[ "${{ steps.check.outputs.auto_merge }}" == "true" ]]; then
            git commit -m "chore: auto-update adapter versions (patch)

          ${{ steps.check.outputs.changes }}

          Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          else
            git commit -m "chore: update versions

          ${{ steps.check.outputs.changes }}

          Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          fi

          git push origin maintenance --force

      - name: Run tests on updated versions
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # Validate the updated configuration
          python .github/scripts/quick_validate_versions.py

          # Run a subset of tests to validate the version updates
          python -m pytest src/tests/integration/mcp/test_config_multilang.py -v --tb=short

      - name: Auto-merge and release (patch updates only)
        if: steps.check.outputs.auto_merge == 'true' || github.event.inputs.force_release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Merge maintenance branch to main
          git checkout main
          git merge maintenance --no-ff -m "Merge maintenance branch: patch-level version updates"
          git push origin main

          # Note: Release workflow (release-pr.yaml) is triggered by PRs, not workflow_dispatch
          # To release: create a release/X.Y.Z branch and open PR to main

      - name: Create Pull Request (manual review required)
        if: steps.check.outputs.has_updates == 'true' && steps.check.outputs.auto_merge == 'false' && github.event.inputs.force_release == 'false'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head maintenance --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "âœ… PR already exists: #$EXISTING_PR"
          else
            # Build PR body with heredoc
            PR_BODY=$(cat <<'EOF'
          ## Test Matrix Version Updates

          This PR updates the test matrix with the latest available versions.

          ### Changes
          CHANGES_PLACEHOLDER

          ### Update Types
          `UPDATE_TYPES_PLACEHOLDER`

          ### Version Report
          ```
          REPORT_PLACEHOLDER
          ```

          ### Checklist
          - [ ] Review version compatibility
          - [ ] Check adapter compatibility
          - [ ] Verify CI passes with new versions
          - [ ] Update documentation if needed
          - [ ] Consider if this should trigger a release

          ---
          *This PR was automatically generated by the version update workflow.*
          *Manual review required due to minor/major version updates.*
          EOF
            )

            # Replace placeholders with actual values
            PR_BODY=$(echo "$PR_BODY" | sed "s|CHANGES_PLACEHOLDER|${{ steps.check.outputs.changes }}|g")
            PR_BODY=$(echo "$PR_BODY" | sed "s|UPDATE_TYPES_PLACEHOLDER|${{ steps.check.outputs.update_types }}|g")
            PR_BODY=$(echo "$PR_BODY" | sed "s|REPORT_PLACEHOLDER|${{ steps.check.outputs.report }}|g")

            # Create PR
            PR_URL=$(gh pr create \
              --base main \
              --head maintenance \
              --title "ðŸ”„ Update test matrix versions" \
              --body "$PR_BODY" \
              --label "dependencies,automated,test-matrix,manual-review" \
              2>&1)

            # Extract PR number from URL
            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "âœ… Created PR #$PR_NUMBER"
          fi

  check-eol-versions:
    runs-on: ubuntu-latest
    needs: [load-versions, check-versions]
    if: always()  # Run even if check-versions fails
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ needs.load-versions.outputs.python-version }}

      - name: Install dependencies
        run: |
          pip install pyyaml requests packaging tomli

      - name: Check for EOL versions
        id: eol
        run: |
          # Custom EOL checking logic
          python -c "
          import yaml
          import os
          from datetime import datetime, timedelta

          with open('versions.json') as f:
              config = yaml.safe_load(f)

          eol_versions = []
          warning_versions = []
          now = datetime.now()
          warning_threshold = now + timedelta(days=30)

          for lang, lang_config in config.get('languages', {}).items():
              for version_info in lang_config.get('supported_versions', []):
                  eol_str = version_info.get('end_of_life')
                  if not eol_str:
                      continue

                  try:
                      eol_date = datetime.strptime(eol_str, '%Y-%m-%d')
                  except ValueError:
                      try:
                          eol_date = datetime.strptime(eol_str, '%Y-%m')
                      except ValueError:
                          continue

                  if eol_date < now:
                      eol_versions.append(f'{lang} {version_info[\"version\"]} (EOL: {eol_str})')
                  elif eol_date < warning_threshold:
                      warning_versions.append(f'{lang} {version_info[\"version\"]} (EOL: {eol_str})')

          output = os.environ.get('GITHUB_OUTPUT')
          if output:
              with open(output, 'a') as f:
                  if eol_versions:
                      f.write('has_eol=true\n')
                      f.write('eol_versions<<EOF\n')
                      f.write('\n'.join(eol_versions) + '\n')
                      f.write('EOF\n')
                  else:
                      f.write('has_eol=false\n')

                  if warning_versions:
                      f.write('has_warnings=true\n')
                      f.write('warning_versions<<EOF\n')
                      f.write('\n'.join(warning_versions) + '\n')
                      f.write('EOF\n')
                  else:
                      f.write('has_warnings=false\n')
          "

      - name: Create issue for EOL versions
        if: steps.eol.outputs.has_eol == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'âš ï¸ EOL versions detected in test matrix';
            const body = `## End-of-Life Versions Detected

            The following versions have reached end-of-life and should be removed from the test matrix:

            ${{ steps.eol.outputs.eol_versions }}

            ### Action Required
            - [ ] Remove EOL versions from \`versions.json\`
            - [ ] Update CI workflows if needed
            - [ ] Verify no production dependencies on EOL versions
            - [ ] Consider migration guide for users

            ---
            *This issue was automatically created by the version maintenance workflow.*`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['test-matrix', 'maintenance', 'eol', 'high-priority']
            });

      - name: Create issue for upcoming EOL versions
        if: steps.eol.outputs.has_warnings == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸ“… Upcoming EOL versions in test matrix';
            const body = `## Versions Approaching End-of-Life

            The following versions will reach end-of-life within 30 days:

            ${{ steps.eol.outputs.warning_versions }}

            ### Planning Required
            - [ ] Plan migration timeline for each version
            - [ ] Identify replacement versions
            - [ ] Communicate timeline to users
            - [ ] Prepare version removal PRs

            ---
            *This issue was automatically created by the version maintenance workflow.*`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['test-matrix', 'maintenance', 'eol-warning', 'planning']
            });
