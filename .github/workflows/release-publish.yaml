name: Publish Release

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  publish:
    # Only run if PR was merged (not just closed) and came from a release branch
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract version from branch name
        id: extract
        uses: ./.github/actions/extract-version
        with:
          branch_name: ${{ github.event.pull_request.head.ref }}
          fail_on_invalid: true

      - name: Find and publish draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          TAG_NAME="${{ steps.extract.outputs.tag_name }}"

          echo "ðŸ” Looking for draft release: $TAG_NAME"

          # Check if draft release exists
          RELEASE_INFO=$(gh release view "$TAG_NAME" --json isDraft,tagName 2>/dev/null || echo "")

          if [ -z "$RELEASE_INFO" ]; then
            echo "::error::Draft release $TAG_NAME not found!"
            echo "::error::Expected a draft release to be created by the pr-release workflow."
            exit 1
          fi

          # Check if it's a draft
          IS_DRAFT=$(echo "$RELEASE_INFO" | jq -r '.isDraft')

          if [ "$IS_DRAFT" = "false" ]; then
            echo "âš ï¸  Release $TAG_NAME is already published"
            echo "Skipping publish step (release may have been manually published)"
            exit 0
          fi

          echo "ðŸ“¦ Publishing draft release $TAG_NAME..."

          # Edit release to mark as published and latest
          gh release edit "$TAG_NAME" \
            --draft=false \
            --latest

          echo "âœ… Release $TAG_NAME published successfully!"

      - name: Verify release is published
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.extract.outputs.tag_name }}"

          # Wait a moment for the edit to propagate
          sleep 2

          # Verify release is published
          RELEASE_INFO=$(gh release view "$TAG_NAME" --json isDraft,url)

          IS_DRAFT=$(echo "$RELEASE_INFO" | jq -r '.isDraft')
          RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '.url')

          if [ "$IS_DRAFT" = "true" ]; then
            echo "::error::Release is still marked as draft!"
            exit 1
          fi

          echo "âœ… Release verification passed:"
          echo "  - Draft: $IS_DRAFT"
          echo "  - URL: $RELEASE_URL"

      - name: Add workflow summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          TAG_NAME="${{ steps.extract.outputs.tag_name }}"

          echo "## ðŸŽ‰ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Merged by**: @${{ github.event.pull_request.merged_by.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get release URL
          RELEASE_URL=$(gh release view "$TAG_NAME" --json url --jq '.url' 2>/dev/null || echo "")

          if [ -n "$RELEASE_URL" ]; then
            echo "[ðŸ”— View Published Release]($RELEASE_URL)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify installation from PyPI: \`pip install ai-debugger-inc==$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Test VS Code extension from release assets" >> $GITHUB_STEP_SUMMARY
          echo "3. Announce release to community" >> $GITHUB_STEP_SUMMARY

  sync-dependabot-updates:
    needs: publish
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.AIDB_APP_ID }}
          private-key: ${{ secrets.AIDB_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: dependabot-updates
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Configure git
        run: |
          git config user.name "aidb-automation[bot]"
          git config user.email "automation@ai-debugger.com"

      - name: Sync dependabot-updates with main
        id: sync
        env:
          RELEASE_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "ðŸ”„ Syncing dependabot-updates with main after release from $RELEASE_BRANCH..."

          # Fetch latest main
          git fetch origin main

          # Merge main into dependabot-updates
          if git merge origin/main --no-edit -m "chore: sync dependabot-updates with main after release merge"; then
            echo "âœ… Successfully synced with main"
            echo "sync_success=true" >> $GITHUB_OUTPUT

            # Push the sync commit
            git push origin dependabot-updates
          else
            echo "âš ï¸ Merge conflict detected when syncing with main"
            echo "This is unexpected after a release. Manual intervention may be required."
            echo "sync_success=false" >> $GITHUB_OUTPUT

            # Abort the merge
            git merge --abort
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Dependabot Updates Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.sync.outputs.sync_success }}" = "true" ]; then
            echo "âœ… **Status**: Successfully synced" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The \`dependabot-updates\` branch has been synchronized with \`main\` after the release." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Sync failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Manual intervention required to sync \`dependabot-updates\` with \`main\`." >> $GITHUB_STEP_SUMMARY
          fi
