name: Build Test Dependencies

on:
  push:
    branches: [main, develop]
    # Skip release merges checked at job level (already tested by release-pr workflow)
    paths:
      - 'src/aidb/adapters/**'
      - 'src/tests/_docker/**'
      - '.github/workflows/build-test-deps.yaml'
      - '.github/workflows/build-*.yaml'
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to use (overrides versions.json if provided)'
        type: string
        required: false

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Check if this is a release merge (already tested by release-pr workflow)
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: Check if release merge
        id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Skip if this is a push event and the commit message indicates a release merge
          if [[ "$EVENT_NAME" == "push" ]]; then
            if [[ "$COMMIT_MSG" =~ Merge\ pull\ request.*from.*release/ ]]; then
              echo "⏭️ Skipping: This is a release merge (already tested by release-pr workflow)"
              echo "should_skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "should_skip=false" >> $GITHUB_OUTPUT

  # Load versions from versions.json
  load-versions:
    needs: check-skip
    if: ${{ needs.check-skip.outputs.should_skip != 'true' }}
    uses: ./.github/workflows/load-versions.yaml

  build-adapters:
    needs: [check-skip, load-versions]
    if: ${{ needs.check-skip.outputs.should_skip != 'true' }}
    uses: ./.github/workflows/build-adapters.yaml
    with:
      python-version: ${{ inputs.python-version || needs.load-versions.outputs.python-version }}

  build-docker-images:
    needs: [check-skip, load-versions]
    if: ${{ needs.check-skip.outputs.should_skip != 'true' }}
    uses: ./.github/workflows/build-docker.yaml
    with:
      python-version: ${{ inputs.python-version || needs.load-versions.outputs.python-version }}

  build-summary:
    name: Build Summary
    needs: [build-adapters, build-docker-images]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build results
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Debug Adapters | ${{ needs.build-adapters.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Images | ${{ needs.build-docker-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-adapters.result }}" == "success" ]] && \
             [[ "${{ needs.build-docker-images.result }}" == "success" ]]; then
            echo "✅ All builds succeeded!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "❌ Some builds failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
